<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background-image: url(../static/images/userdash.jpg);
        background-size: cover;
        background-repeat: no-repeat;
        margin: 0;
        padding: 0;
      }

      .navbar {
        background-color: #00637f !important;
        padding: 10px;
      }

      .navbar h3 {
        margin: 0;
        color: white;
      }

      .main-content {
        padding: 20px;
        text-align: center;
      }

      .card-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
      }

      .appointment-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 380px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        border-top: 6px solid #004080;
        border-bottom: 6px solid #004080;
      }

      .appointment-card:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 128, 255, 0.4);
      }

      .appointment-card h3 {
        background: #004080;
        color: white;
        padding: 10px;
        border-radius: 8px;
        width: 100%;
        font-size: 18px;
      }

      .appointment-card p {
        font-size: 15px;
        color: #444;
        margin: 6px 0;
        width: 100%;
        text-align: left;
      }

      .highlight {
        color: #44ff00;
        font-weight: bold;
      }

      .queue_number {
        color: red;
        font-weight: bold;
        font-size: 16px;
      }

      .status {
        font-size: 14px;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 5px;
        display: inline-block;
        margin-top: 10px;
      }

      .status-confirmed {
        background: #28a745;
        color: white;
      }

      .status-pending {
        background: #ffc107;
        color: black;
      }

      .icon {
        font-size: 16px;
        color: #00637f;
        margin-right: 6px;
      }

      /* Download Button */
      .download-btn {
        background: #004080;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        margin-top: 10px;
        font-size: 14px;
        transition: 0.3s;
      }

      .download-btn:hover {
        background: #006bb3;
      }
    </style>
  </head>

  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <h3 class="text-light">Government of NCT of Delhi</h3>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-light" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/appointment">Appointment</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/bed_status">Bed Availability</a></li>
          <li class="nav-item">
            <a class="nav-link text-light" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal">
              <i class="fas fa-bell"></i>
            </a>
          </li>
          <li class="nav-item"><a class="nav-link text-light" href="/user_logout">Logout</a></li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <h1 style="color: rgba(0, 255, 34, 0.387);">
        Welcome, <span class="highlight">{{ user.name }}</span>
      </h1>

      <!-- Appointment Cards Section -->
      <div class="card-container">
        {% for contact in appointments %}
        <div class="appointment-card" id="card-{{ loop.index }}">
          <h3>Appointment Details</h3>
          <p><i class="fas fa-user icon"></i><strong>Name:</strong> {{ contact.name }}</p>
          <p><i class="fas fa-envelope icon"></i><strong>Email:</strong> {{ contact.email }}</p>
          <p><i class="fas fa-phone icon"></i><strong>Number:</strong> {{ contact.number }}</p>
          <p><i class="fas fa-calendar-alt icon"></i><strong>Appointment Date:</strong> {{ contact.appointment_date }}
          </p>
          <p><i class="fas fa-hospital icon"></i><strong>Hospital Name:</strong> {{ contact.hospital_name }}</p>
          <p><i class="fas fa-clock icon"></i><strong>Time-slot:</strong> {{ contact.time_slot }}</p>
          <p><i class="fas fa-stethoscope icon"></i><strong>Department:</strong> {{ contact.speciality }}</p>
          <p><i class="fas fa-user-md icon"></i><strong>Doctor Name:</strong> {{ contact.appointed_doc }}</p>
          <p><i class="fas fa-notes-medical icon"></i><strong>Description:</strong> {{ contact.disease_description }}
          </p>
          <p class="queue_number"><i class="fas fa-list-ol icon"></i><strong>Queue Number:</strong>
            {{ contact.queue_number }}
          </p>

          {% if contact.status == "Confirmed" %}
          <span class="status status-confirmed">Confirmed</span>
          {% else %}
          <span class="status status-pending">Pending</span>
          {% endif %}

          <!-- Download PDF Button -->
          <button class="download-btn" onclick="downloadPDF('{{ loop.index }}')">Download PDF</button>
        </div>
        {% endfor %}
      </div>
    </div>

    <script>
      function downloadPDF(cardId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const card = document.getElementById("card-" + cardId);
        const content = card.innerText;

        doc.setFontSize(14);
        doc.text(content, 10, 10);
        doc.save("appointment_details.pdf");
      }
    </script>

    <script src="../static/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      async function downloadPDF(cardId) {
        const { jsPDF } = window.jspdf;
        const card = document.getElementById("card-" + cardId);
        const downloadBtn = card.querySelector(".download-btn");

        // Hide the button before capturing
        downloadBtn.style.display = "none";

        // Capture the card as an image
        html2canvas(card, { scale: 3 }).then(canvas => {
          const imgData = canvas.toDataURL("image/png");
          const pdf = new jsPDF("p", "mm", "a4");

          const imgWidth = 190; // Fit within A4 width
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);

          // Get the username from the card
          const userName = card.querySelector("p strong").nextSibling.nodeValue.trim();
          pdf.save(`${userName}-Appointment.pdf`);

          // Show the button again after capturing
          downloadBtn.style.display = "block";
        });
      }
    </script>

  </body>

</html>